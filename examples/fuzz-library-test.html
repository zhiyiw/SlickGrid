<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">  
    <title>Fuzz Library: Tests</title>
  <link rel="stylesheet" href="../slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
  <link rel="stylesheet" href="examples.css" type="text/css"/>
    <link rel="stylesheet" href="../plugins/slick.headermenu.css" type="text/css"/>
        <link rel="stylesheet" href="fuzz_library.css" type="text/css"/>
    <style>
   body {

background: #dbe0e3;

   }

  </style>




</head>
<body>
   <div id="myGrid" style="width:90%;height:700px;"></div>


<script src="../lib/jquery-1.7.min.js"></script>
<script src="../lib/jquery-ui-1.8.16.custom.min.js"></script>
<script src="../lib/jquery.event.drag-2.0.min.js"></script>

<script src="../slick.core.js"></script>
<script src="../plugins/slick.checkboxselectcolumn.js"></script>
<script src="../plugins/slick.autotooltips.js"></script>
<script src="../plugins/slick.cellrangedecorator.js"></script>
<script src="../plugins/slick.cellrangeselector.js"></script>
<script src="../plugins/slick.cellcopymanager.js"></script>
<script src="../plugins/slick.cellselectionmodel.js"></script>
<script src="../plugins/slick.rowselectionmodel.js"></script>
<script src="../slick.formatters.js"></script>
<script src="../slick.editors.js"></script>
<script src="../slick.grid.js"></script>
<script src="../slick.dataview.js"></script>
<script src="../plugins/slick.headermenu.js"></script>



<script>
function requiredFieldValidator(value) {
  if (value == null || value == undefined || !value.length) {
    return {valid: false, msg: "This is a required field"};
  } else {
    return {valid: true, msg: null};
  }
};


var FuzzNameFormatter = function(row, cell, value, columnDef, dataContext) {


  };


var TaskNameFormatter = function(row, cell, value, columnDef, dataContext) {
    value = value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
   //   console.log(value);
    var spacer = "<span style='display:inline-block;height:1px;width:" + (15 * dataContext["indent"]) + "px'></span>";
    var idx = dataView.getIdxById(dataContext.id);
    //     if(data[idx].parent != null){
    //   console.log(data[idx].parent);



    // }

   
  // console.log(idx); 
    if(data[idx + 1] && data[idx + 1].indent > data[idx].indent) {
      if(dataContext._collapsed) {
        return spacer + " <span class='toggle expand'></span>&nbsp;" + value;
      } else {

        return spacer + " <span class='toggle collapse'></span>&nbsp;" + value;
      }
    } else {
      return spacer + " <span class='toggle'></span>&nbsp;" + value;
    };
  



  };


var dataView;
var grid;
var data = [];
var columns = [];
var checkboxSelector = new Slick.CheckboxSelectColumn({
  cssClass: "slick-cell-checkboxsel"
});


columns = [

{
  id: "name",
  name: "Name",
  field: "name",
  width: 220,
  cssClass: "cell-title",
  formatter: TaskNameFormatter,
  editor: Slick.Editors.Text,
  validator: requiredFieldValidator
}, {
  id: "protocol",
  name: "Protocol",
  field: "protocol",
  editor: Slick.Editors.Text
},{
  id: "restater",
  name: "Restater",
  field: "restater",
  editor: Slick.Editors.Text
}, {
  id: "monitors",
  name: "Monitors",
  field: "monitors",
  editor: Slick.Editors.Text
},  
{
  id: "suites",
  name: "Suites(Variants)",
  field: "suites",
  editor: Slick.Editors.Text
},

{
  id: "created",
  name: "Created",
  field: "created",
  minWidth: 60,
  editor: Slick.Editors.Date
},  {
  id: "effort-driven",
  name: "Effort Driven",
  width: 80,
  minWidth: 20,
  maxWidth: 80,
  cssClass: "cell-effort-driven",
  field: "effortDriven",
  formatter: Slick.Formatters.Checkmark,
  editor: Slick.Editors.Checkbox,
  cannotTriggerInsert: true
}, {
  id: "%",
  name: "% Complete",
  field: "percentComplete",
  width: 80,
  resizable: false,
  formatter: Slick.Formatters.PercentCompleteBar,
  editor: Slick.Editors.PercentComplete
}, {
  id: "dropdown_menu",
  name: "Menu",
  width: 80,
  minWidth: 20,
  maxWidth: 80
}];

//add checkbox
columns.unshift(checkboxSelector.getColumnDefinition());


//header menu:

//for (var i = 0; i < columns.length; i++) {
columns[9].header = {
  menu: {
    items: [{

      iconCssClass: "icon-runtest",
      title: "Run Test",
      command: "sort-asc",
      tooltip: "Run the test"
    }, {

      iconCssClass: "icon-viewreport",
      title: "View Report",
      command: "sort-desc",
      tooltip: "View Report"
    }, {

      iconCssClass: "icon-delete",
      title: "Delete",
      command: "sort-desc",
      tooltip: "Delete"
    },

    {
      iconCssClass: "icon-help",
      title: "Help",
      command: "help"
    }]
  }
};
// }
var options = {
  editable: false,
  enableColumnReorder: false,
  enableAddRow: true,
  enableCellNavigation: true,
  asyncEditorLoading: false,
  enableTextSelectionOnCells: true,
  forceFitColumns: true
};

var percentCompleteThreshold = 0;
var searchString = "";

function myFilter(item) {
  if(item["percentComplete"] < percentCompleteThreshold) {
    return false;
  }

  if(searchString != "" && item["name"].indexOf(searchString) == -1) {
    return false;
  }

  if(item.parent != null) {   //this methods control the show/hide child
    var parent = data[item.parent];

    while(parent) {
      if(parent._collapsed || (parent["percentComplete"] < percentCompleteThreshold) || (searchString != "" && parent["name"].indexOf(searchString) == -1)) {
        return false;
      }

      parent = data[parent.parent];
    }
  }

  return true;
}

function percentCompleteSort(a, b) {
  return a["percentComplete"] - b["percentComplete"];
}


$(function() {

  var indent = 0;
 var parents = [];


 var testChildName = ["Suites", "Restarter Command", "Recovery Time", "Monitor Command", "Fault Patterns"]

 // prepare the data

 for(var i = 0; i < 60; i++) {
  var d = (data[i] = {});
  var parent = null;
  //prepare parent data:
  if(i % 6 != 0) { //child
    indent = 1;
   // console.log(indent);
  //   console.log(i);
    parent = parseInt(i/6) * 6;
    d["parent"] = parent;
    parents.push(parent);

    switch(i % 6) {
    case 1:

      d["name"] = testChildName[0];
      d["protocol"] = "BGP Messages, BGP Route Flap";
      break;
    case 2:
      d["name"] = testChildName[1];
      d["protocol"] = "start /r /d p:0:0";
      break;
    case 3:

      d["name"] = testChildName[2];
      d["protocol"] = "60 s";;
      break;
    case 4:

      d["name"] = testChildName[3];
      d["protocol"] = "timed_fault 150 3";;
      break;
    case 5:

      d["name"] = testChildName[4];
      d["protocol"] = "greater than 70 /cpu\\:\\s(\\d+)/";;
      break;
    };


  } else if(i % 6 == 0) { //back to parent
    indent = 0;
 
    parent = parents.pop();
    d["parent"] = null;
    d["name"] = "Test " + i/6;
    d["protocol"] = "HTTP";
    //d["_collapsed"] = true;  //this controls the parent ini action of collaper
  } else if (parents.length > 0) {
      parent = parents[parents.length - 1];
    }

  if(indent == 0) {
    parent = null;
  }


  d["id"] = "id_" + i;
  d["indent"] = indent;


  d["restater"] = Math.round(Math.random() * 10);
  d["monitors"] = Math.round(Math.random() * 1 + 1);
  d["suites"] = Math.round(Math.random() * 100);
  d["percentComplete"] = Math.round(Math.random() * 100);
  d["created"] = "01/10/2013";
  // d["finish"] = "01/25/2013";
  d["effortDriven"] = (i % 5 == 0);



}









   
  // initialize the model
  dataView = new Slick.Data.DataView({inlineFilters: true});
  dataView.beginUpdate();
  dataView.setItems(data);
  dataView.setFilter(myFilter);
  dataView.endUpdate();


dataView.getItemMetadata = function(row) {
  if(data[row]) {   //this is vital!!!!
    var thtId = data[row].id;
 console.log("row.id:"+data[row].id);
  console.log("row:"+row);
     console.log("parent:"+data[row].parent );
    if(data[row].parent != null) {
   
      return {
        // specify additional CSS class for a specific row
        "columns": {
          "protocol": {
            "colspan": "*" 
          }
        }

      }


    }

  }


}





// dataView.getItemMetadata = function (row) {
    
//     var idx = dataView.getIdxById(dataContext.id);
//         if(data[idx].parent != null){
//       console.log(data[idx].parent);



//     }

//     if (data[idx].parent != null) {
//       return {
//         "columns": {
//           "protocol": {
//             "colspan": 3
//           }
//         }
//       };
//     } else {
//       return {
//         "columns": {
//           0: {
//             "colspan": "*"
//           }
//         }
//       };
//     }
//   };
 // code to test the colspan

  grid = new Slick.Grid("#myGrid", dataView, columns, options);

  grid.onCellChange.subscribe(function(e, args) {
    dataView.updateItem(args.item.id, args.item);
  });

  // grid.onAddNewRow.subscribe(function(e, args) {
  //   var item = {
  //     "id": "new_" + (Math.round(Math.random() * 10000)),
  //     "indent": 0,
  //     "title": "New task",
  //     "protocol": "1 day",
  //     "percentComplete": 0,
  //     "created": "01/01/2009",
  //     "finish": "01/01/2009",
  //     "effortDriven": false
  //   };
  //   $.extend(item, args.item);
  //   dataView.addItem(item);
  // });


  grid.onClick.subscribe(function(e, args) {
    if($(e.target).hasClass("toggle")) {
      var item = dataView.getItem(args.row);
      if(item) {
        if(!item._collapsed) {
          item._collapsed = true;
        } else {
          item._collapsed = false;
        }

        dataView.updateItem(item.id, item);
      }
      e.stopImmediatePropagation();
    }



  });


  // wire up model events to drive the grid
  dataView.onRowCountChanged.subscribe(function(e, args) {
  //  console.log(e);

    grid.updateRowCount();
    grid.render();
  });

  dataView.onRowsChanged.subscribe(function(e, args) {
  //  console.log(e);
    grid.invalidateRows(args.rows);
    grid.render();
  });


  var headerMenuPlugin = new Slick.Plugins.HeaderMenu({});

  // headerMenuPlugin.onBeforeMenuShow.subscribe(function(e, args) {
  //   var menu = args.menu;
  //   // We can add or modify the menu here, or cancel it by returning false.
  //   var i = menu.items.length;
  //   menu.items.push({
  //     title: "Menu item " + i,
  //     command: "item" + i
  //   });
  // });
  headerMenuPlugin.onCommand.subscribe(function(e, args) {
    alert("Command: " + args.command);
  });

  grid.setSelectionModel(new Slick.RowSelectionModel({
    selectActiveRow: false
  })); // this line must before register plugin
  grid.registerPlugin(headerMenuPlugin);
  grid.registerPlugin(checkboxSelector);


  //    grid.setSelectionModel(new Slick.CellSelectionModel());
})
</script>
</body>
</html>
