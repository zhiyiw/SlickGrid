<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">  
    <title>SlickGrid example 5: Collapsing</title>
  <link rel="stylesheet" href="../slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
  <link rel="stylesheet" href="examples.css" type="text/css"/>
    <link rel="stylesheet" href="../plugins/slick.headermenu.css" type="text/css"/>
    <style>
    .cell-title {
      font-weight: bold;
    }

    .cell-effort-driven {
      text-align: center;
    }

    .toggle {
      height: 10px;
      width: 10px;
      display: inline-block;
    }

    .toggle.expand {
      background: url(../images/dropdown_arrow_plus_10x10.png) no-repeat center center;
    }

    .toggle.collapse {
      background: url(../images/dropdown_arrow_minus_10x10.png) no-repeat center center;
    }




    .slick-header-menu {
      border: 1px solid #718BB7;
      background: #a4bac3;
      padding: 0px;  

      -moz-box-shadow: 2px 2px 2px silver;
      -webkit-box-shadow: 2px 2px 2px silver;
      min-width: 100px;
      z-index: 20;
    }


    .slick-header-menuitem {
      color:##4A4A4A;
      font-weight:bold;

      
      padding: 6px 10px;
   //   border-bottom:1px solid white;
       border-bottom:1px solid #8fa4ad;
     // border: 1px solid;
      //border-radius: 3px;
    }

    .slick-header-menuitem:hover {
      border-color: silver;
      background: white;
    }

    .slick-header-menuitem-disabled {
      border-color: transparent !important;
      background: inherit !important;
    }

    .icon-help {
      background-image: url(../images/help.png);
    }

  </style>




</head>
<body>
   <div id="myGrid" style="width:90%;height:500px;"></div>


<script src="../lib/jquery-1.7.min.js"></script>
<script src="../lib/jquery-ui-1.8.16.custom.min.js"></script>
<script src="../lib/jquery.event.drag-2.0.min.js"></script>

<script src="../slick.core.js"></script>
<script src="../plugins/slick.cellrangedecorator.js"></script>
<script src="../plugins/slick.cellrangeselector.js"></script>
<script src="../plugins/slick.cellselectionmodel.js"></script>
<script src="../slick.formatters.js"></script>
<script src="../slick.editors.js"></script>
<script src="../slick.grid.js"></script>
<script src="../slick.dataview.js"></script>
<script src="../plugins/slick.headermenu.js"></script>

<script>
function requiredFieldValidator(value) {
  if (value == null || value == undefined || !value.length) {
    return {valid: false, msg: "This is a required field"};
  } else {
    return {valid: true, msg: null};
  }
};


var TaskNameFormatter = function (row, cell, value, columnDef, dataContext) {
  value = value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  var spacer = "<span style='display:inline-block;height:1px;width:" + (15 * dataContext["indent"]) + "px'></span>";
  var idx = dataView.getIdxById(dataContext.id);
  if (data[idx + 1] && data[idx + 1].indent > data[idx].indent) {
    if (dataContext._collapsed) {
      return spacer + " <span class='toggle expand'></span>&nbsp;" + value;
    } else {
    
      return spacer + " <span class='toggle collapse'></span>&nbsp;" + value;
    }
  } else {
    return spacer + " <span class='toggle'></span>&nbsp;" + value;
  }
};


var dataView;
  var grid;
  var data = [];
  var columns = [
  {id: "title", name: "Title", field: "title", width: 220, cssClass: "cell-title", formatter: TaskNameFormatter, editor: Slick.Editors.Text, validator: requiredFieldValidator},
  {id: "duration", name: "Duration", field: "duration", editor: Slick.Editors.Text},
  {id: "%", name: "% Complete", field: "percentComplete", width: 80, resizable: false, formatter: Slick.Formatters.PercentCompleteBar, editor: Slick.Editors.PercentComplete},
  {id: "start", name: "Start", field: "start", minWidth: 60, editor: Slick.Editors.Date},
  {id: "finish", name: "Finish", field: "finish", minWidth: 60, editor: Slick.Editors.Date},
  {id: "effort-driven", name: "Effort Driven", width: 80, minWidth: 20, maxWidth: 80, cssClass: "cell-effort-driven", field: "effortDriven", formatter: Slick.Formatters.Checkmark, editor: Slick.Editors.Checkbox, cannotTriggerInsert: true}
];


//header menu:

  for (var i = 0; i < columns.length; i++) {
    columns[i].header = {
      menu: {
        items: [
          {
            iconImage: "../images/menu_runtest_17x17.png",
            title: "Run Test",
            command: "sort-asc"
          },
          {
            iconImage: "../images/menu_viewreport_17x17.png",
            title: "View Report",
            command: "sort-desc"
          },
           {
            iconImage: "../images/menu_delete_17x17.png",
            title: "Delete",
            command: "sort-desc"
          },
          {
            title: "Hide Column",
            command: "hide",
            disabled: true,
            tooltip: "Can't hide this column"
          },
          {
            iconCssClass: "icon-help",
            title: "Help",
            command: "help"
          }
        ]
      }
    };
  }


  var options = {
     editable: false,
  enableAddRow: true,
  enableCellNavigation: true,
  asyncEditorLoading: false,
  enableTextSelectionOnCells: true,
    forceFitColumns: true
  };

var percentCompleteThreshold = 0;
var searchString = "";

function myFilter(item) {
  if (item["percentComplete"] < percentCompleteThreshold) {
    return false;
  }

  if (searchString != "" && item["title"].indexOf(searchString) == -1) {
    return false;
  }

  if (item.parent != null) {
    var parent = data[item.parent];

    while (parent) {
      if (parent._collapsed || (parent["percentComplete"] < percentCompleteThreshold) || (searchString != "" && parent["title"].indexOf(searchString) == -1)) {
        return false;
      }

      parent = data[parent.parent];
    }
  }

  return true;
}

function percentCompleteSort(a, b) {
  return a["percentComplete"] - b["percentComplete"];
}



  $(function () {
    // var data = [];
    // for (var i = 0; i < 10; i++) {
    //   data[i] = {
    //     title: "Task " + i,
    //     duration: "5 days",
    //     percentComplete: Math.round(Math.random() * 100),
    //     start: "01/01/2009",
    //     finish: "01/05/2009",
    //     effortDriven: (i % 5 == 0)
    //   };
    // }

 var indent = 0;
  var parents = [];

  // prepare the data
  for (var i = 0; i < 1000; i++) {
    var d = (data[i] = {});
    var parent = null;

    if (Math.random() > 0.8) {
      indent++;
      parent = i - 1;
      parents.push(parent);
    } else if (Math.random() < 0.3 && indent > 0) {
      indent--;
      parent = parents.pop();
    } else if (parents.length > 0) {
      parent = parents[parents.length - 1];
    }

    if (indent == 0) {
      parent = null;
    }

    d["id"] = "id_" + i;
    d["indent"] = indent;
    d["parent"] = parent;
    d["title"] = "Task " + i;
    d["duration"] = "5 days";
    d["percentComplete"] = Math.round(Math.random() * 100);
    d["start"] = "01/10/2013";
    d["finish"] = "01/25/2013";
    d["effortDriven"] = (i % 5 == 0);
  }

  // initialize the model
  dataView = new Slick.Data.DataView({ inlineFilters: true });
  dataView.beginUpdate();
  dataView.setItems(data);
  dataView.setFilter(myFilter);
  dataView.endUpdate();



    dataView.getItemMetadata = function (row) {
      if (row % 2 === 0) {
        return {
          "columns": {
            "duration": {
              "colspan": 1
            }
          }
        };
      } else {
        return {
          "columns": {
            0: {
              "colspan": "*"
            }
          }
        };
      }
    };

    grid = new Slick.Grid("#myGrid", dataView, columns, options);

    grid.onCellChange.subscribe(function (e, args) {
    dataView.updateItem(args.item.id, args.item);
  });

    grid.onAddNewRow.subscribe(function (e, args) {
    var item = {
      "id": "new_" + (Math.round(Math.random() * 10000)),
      "indent": 0,
      "title": "New task",
      "duration": "1 day",
      "percentComplete": 0,
      "start": "01/01/2009",
      "finish": "01/01/2009",
      "effortDriven": false};
    $.extend(item, args.item);
    dataView.addItem(item);
  });


     grid.onClick.subscribe(function (e, args) {
    if ($(e.target).hasClass("toggle")) {
      var item = dataView.getItem(args.row);
      if (item) {
        if (!item._collapsed) {
          item._collapsed = true;
        } else {
          item._collapsed = false;
        }

        dataView.updateItem(item.id, item);
      }
      e.stopImmediatePropagation();
    }
  });


  // wire up model events to drive the grid
  dataView.onRowCountChanged.subscribe(function (e, args) {
       console.log(e);
    grid.updateRowCount();
    grid.render();
  });

  dataView.onRowsChanged.subscribe(function (e, args) {
    console.log(e);
    grid.invalidateRows(args.rows);
    grid.render();
  });


    var headerMenuPlugin = new Slick.Plugins.HeaderMenu({});

    // headerMenuPlugin.onBeforeMenuShow.subscribe(function(e, args) {
    //   var menu = args.menu;

    //   // We can add or modify the menu here, or cancel it by returning false.
    //   var i = menu.items.length;
    //   menu.items.push({
    //     title: "Menu item " + i,
    //     command: "item" + i
    //   });
    // });

    headerMenuPlugin.onCommand.subscribe(function(e, args) {
      alert("Command: " + args.command);
    });

    grid.registerPlugin(headerMenuPlugin);

//    grid.setSelectionModel(new Slick.CellSelectionModel());
  })
</script>
</body>
</html>
